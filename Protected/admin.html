<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Learning Portal</title>
<link rel="stylesheet" href="style.css">
<style>
  body { font-family: "Segoe UI", sans-serif; background: linear-gradient(135deg, #232526, #414345); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding-top: 30px; }
  .container { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); width: 500px; text-align: center; animation: fadeIn 0.6s ease-in-out; margin-bottom: 50px; }
  h1 { margin-bottom: 20px; color: #333; }
  input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; }
  input:focus { border-color: #4cafef; outline: none; }
  button { background: #4cafef; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; border: none; }
  button:hover { background: #0078f0; }
  .hidden { display: none; }
  #status { margin-top: 15px; padding: 10px; border-radius: 8px; font-weight: bold; }
  #status.success { background: #e6fff0; color: #006622; }
  #status.error { background: #ffe6e6; color: #cc0000; }
  .note-list { margin-top: 20px; text-align: left; }
  .note-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border: 1px solid #ccc; border-radius: 8px; margin: 8px 0; background: #f9f9f9; }
  .note-item button { width: auto; padding: 5px 10px; font-size: 14px; margin-left: 5px; }
  @keyframes fadeIn { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
</style>
</head>
<body>
<div class="container">
  <h1>üîê Admin Login</h1>

  <!-- Login Form -->
  <form id="loginForm">
    <input type="text" id="username" placeholder="Admin ID" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>

  <!-- Upload Form -->
  <form id="noteForm" class="hidden" enctype="multipart/form-data">
    <h1>üõ† Upload Study Notes</h1>
    <input type="text" name="subject" placeholder="Subject (e.g., Economics)" required>
    <input type="text" name="topic" placeholder="Topic (e.g., Revenue)" required>
    <input type="file" name="pdf" accept="application/pdf" required>
    <button type="submit">Upload PDF</button>
  </form>

  <!-- Logout Button -->
  <button id="logoutBtn" class="hidden" style="margin-top: 15px;">Logout</button>

  <div id="status"></div>

  <!-- Uploaded notes list -->
  <div class="note-list hidden" id="noteList"></div>
</div>

<script>
const loginForm = document.getElementById("loginForm");
const noteForm = document.getElementById("noteForm");
const logoutBtn = document.getElementById("logoutBtn");
const statusBox = document.getElementById("status");
const noteList = document.getElementById("noteList");

// ---------- Check admin session on page load ----------
async function checkAdminSession() {
  const res = await fetch("/check-session");
  const data = await res.json();
  if (!data.loggedIn) {
    alert("You are not logged in! Redirecting to login page.");
    window.location.href = "/"; // redirect to main login page
  }
}
checkAdminSession();

// ---------- Login ----------
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch("/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  statusBox.innerText = data.message;
  statusBox.className = data.success ? "success" : "error";

  if (data.success) {
    loginForm.classList.add("hidden");
    noteForm.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    noteList.classList.remove("hidden");
    loadNotes();
  }
});

// ---------- Logout ----------
logoutBtn.addEventListener("click", async () => {
  const res = await fetch("/logout", { method: "POST" });
  const data = await res.json();
  statusBox.innerText = data.message;
  statusBox.className = data.success ? "success" : "error";

  loginForm.classList.remove("hidden");
  noteForm.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  noteList.classList.add("hidden");
});

// ---------- Upload Note ----------
noteForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const res = await fetch("/upload-note", { method: "POST", body: formData });
  const data = await res.json();
  statusBox.innerText = data.message;
  statusBox.className = data.success ? "success" : "error";
  if (data.success) { noteForm.reset(); loadNotes(); }
});

// ---------- Load Notes ----------
async function loadNotes() {
  try {
    const res = await fetch("/notes");
    const notes = await res.json();
    if (!notes.length) { noteList.innerHTML = "<p>No notes uploaded yet.</p>"; return; }
    noteList.innerHTML = notes.map((note, index) => `
      <div class="note-item">
        <span>${note.subject} - ${note.topic}</span>
        <div>
          <a href="/${note.file}" target="_blank"><button>View</button></a>
          <button onclick="editNote(${index}, '${note.subject}', '${note.topic}')">Edit</button>
          <button onclick="deleteNote(${index})" style="background:#ff4d4d">Delete</button>
        </div>
      </div>
    `).join('');
  } catch (err) {
    noteList.innerHTML = "<p>Failed to load notes.</p>";
    console.error(err);
  }
}

// ---------- Delete Note ----------
async function deleteNote(index) {
  if (!confirm("Are you sure you want to delete this note?")) return;
  const res = await fetch(`/delete-note/${index}`, { method: "DELETE" });
  const data = await res.json();
  statusBox.innerText = data.message;
  statusBox.className = data.success ? "success" : "error";
  loadNotes();
}

// ---------- Edit Note ----------
async function editNote(index, oldSubject, oldTopic) {
  const newSubject = prompt("Edit Subject:", oldSubject);
  if (newSubject === null) return;
  const newTopic = prompt("Edit Topic:", oldTopic);
  if (newTopic === null) return;

  const res = await fetch(`/edit-note/${index}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ subject: newSubject, topic: newTopic })
  });
  const data = await res.json();
  statusBox.innerText = data.message;
  statusBox.className = data.success ? "success" : "error";
  loadNotes();
}
</script>
</body>
</html>
